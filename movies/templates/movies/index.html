{% extends 'base.html' %}
{% load static %}

{% block content %}
  <div id="app" class="mt-3 container">
    <span id="autocomplete" class="autocomplete">
      <input class="autocomplete-input" name="movie"/>
      <ul class="autocomplete-result-list"></ul>
    </span>
    <input type="text" id="savePK" value=-1 style="display: none;">
    <input type="submit" @click="selectedMovie" value="search">

    <span>장르</span>
    <select v-model="genreStatus" name="" id="">
      <option value="all">전체</option>
      {% for genre in genres %}
        <option value="{{ genre.pk }}">{{ genre.name }}</option>
      {% endfor %}
    </select>
    <span>평점</span>
    <select v-model="voteAverage" name="" id="">
      {% for i in '0123456789'|make_list %}
        <option value="{{ i }}">{{ i }}</option>
      {% endfor %}
    </select>
    <span>이상</span>

    
    
    {% comment %} <div class="container">
      <section class="grid-wrap">
        <ul class="grid swipe-down" id="grid">
          <li class="title-box">
            <h2>Illustrations</h2>
          </li>
          <li>
            dfdf
          </li>
        </ul>
      </section>
    </div> {% endcomment %}


    <div class="row mt-3">
      <div class="card col-3" style="width: 18rem;" v-for="movie in movieListByGenre" :key="movie.pk">
        <img :src="`http://image.tmdb.org/t/p/original/${movie.fields.poster_path}`" class="card-img-top" alt="포스터가 없습니다.">
        <div class="card-body">
          <p class="card-text">[[ movie.fields.title ]]</p>
        </div>
      </div>
    </div>


    <section class="grid-wrap">
      <ul class="grid swipe-down" id="grid">
        <li class="title-box">
          <h2>Illustrations</h2>
        </li>
        <li><a href="#"><img src="{% static 'movies/img/dummy.png' %}" alt="dummy"><h3>A fantastic title</h3></a></li>
      </ul>
    </section>


  </div>

{% endblock %}


{% block script %}
  <script>
    
    /* {let pageNum = 2

    document.addEventListener('scroll', (event) => {
    const {scrollHeight, scrollTop, clientHeight} = document.body
    console.log(scrollHeight - Math.round(scrollTop))
    console.log(clientHeight-1)

      if (scrollHeight - Math.round(scrollTop) === clientHeight - 1) {
        axios({
        method: 'get',
        url: `/movies/?page=${pageNum}`,
        headers: {'x-requested-with': 'XMLHttpRequest'}
        })
          .then((res) => {
            const movies = res.data
            
            movies.forEach((movie) => {
              const movieList = document.querySelector('.movie-list')
              const movieDiv = document.createElement('div')

              const movieHTML = `
                <h3>${ movie.fields.title }</h3>
                <p>${ movie.fields.overview }</p>
                <a href="movies/${ movie.pk }/">[detail]</a>
                <hr>
              `
              movieDiv.innerHTML = movieHTML
              movieList.appendChild(movieDiv)
            })
            pageNum += 1
          })
      
      }
    }) }*/
 
    const app = new Vue({
      delimiters: ['[[', ']]'],
      el: '#app',
      data: {
        allMovies: [],
        movies: [],
        genres: [],
        genreStatus: 'all',
        voteAverage: '0',
      },
      methods: {
        movieList: function () {
          this.movieListByGenre()
        },
        selectedMovie: function () {
          const moviePk = document.querySelector('#savePK').value
          
          for (let tmpMovie of this.allMovies) {
            if (tmpMovie.pk == moviePk) {
              return this.movies = [tmpMovie]
            }
          }
          
        }
      },
      created: function () {
        axios.get('/movies/api-movie/')
          .then((res) => {
            this.movies = res.data
            this.allMovies = res.data
          })
        axios.get('/movies/api-genre/')
          .then((res) => {
            this.genres = res.data
          })
      },
      computed: {
        movieListByGenre: function () {
          if (this.genreStatus != 'all') {
            return this.movies.filter((movie) => {
                for (let tmpGenre of movie.fields.genres){
                  if (movie.fields.vote_average > this.voteAverage) {
                    return tmpGenre == this.genreStatus
                  }
                }
            })
          } else {
            return this.movies.filter((movie) => {
              return movie.fields.vote_average > this.voteAverage
            })
          }
        }
      },
    })

    function saveMoviePK(val) {
      const ele = document.querySelector('#savePK')
      ele.value = val
    }


    new Autocomplete('#autocomplete', {

      search : input => {
        const url = `/movies/search-movie/?movie=${input}`
        return new Promise(resolve => {
          if (input.length < 3) {
            return resolve([])
          }
          fetch(url)
          .then(response => response.json())
          .then(response => {
            resolve(response.data)
          })
        })
      },
      renderResult: (result, props) => `
        <li ${props}>
          <span class="wiki-snippet">
            <img src="http://image.tmdb.org/t/p/original/${result.poster_path}" style="width: 10%;">
          </span>
          <span class="wiki-title">
          ${result.title}
          </span>
        </li>
      `,

      getResultValue: result => result.title,

      onSubmit : result => {
        saveMoviePK(result.id)
      }
    })


  </script>
{% endblock script %}

