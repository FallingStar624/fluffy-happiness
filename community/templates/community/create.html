{% extends 'base.html' %}
{% load bootstrap5 %}

{% block content %}
  <div class="container">
  
    <h1>CREATE</h1>
    
    <form action="" method="POST">
      {% csrf_token %}
      {{ form.non_field_errors }}
      <div class="fieldWrapper">
        {{ form.title.errors }}
        <label for="id_title">Title : </label>
        {{ form.title }}
      </div>
      <div class="fieldWrapper">
          {{ form.movie_title.errors }}
          <label for="id_movie_title">Movie Title : </label>
          <div style="display: none;">{{ form.movie_title }}</div>
            <div id="autocomplete" class="autocomplete">
              <input class="autocomplete-input" name="movie"/>
              <ul class="autocomplete-result-list"></ul>
          </div>
      </div>
      <div class="fieldWrapper">
          {{ form.rank.errors }}
          <label for="id_rank">Rank : </label>
          {{ form.rank }}
          {% include 'community/star_rate.html' %}
      </div>
      <div class="fieldWrapper">
          {{ form.content.errors }}
          <label for="id_content">Content : </label>
          {{ form.content }}
      </div>
      <p><input type="submit" value="Send message" /></p>
    </form>
    <hr>
    <a href="{% url 'community:index' %}">[back]</a>
  </div>


{% endblock content %}

{% block script %}
  <script>

  function fn_selTest( val )
  {
    var ele = document.getElementById('id_movie_title');

    for( i=0,j=ele.length; i<j; i++ )
    {
      if( ele.options[i].innerText == val )
      {
        ele.options[i].selected = true;
        ele.options[i].innerText = val
        break;
      }
    }
  }

    new Autocomplete('#autocomplete', {

      search : input => {
        const url = `/community/search-movie/?movie=${input}`
        return new Promise(resolve => {
          if (input.length < 3) {
            return resolve([])
          }
          fetch(url)
          .then(response => response.json())
          .then(response => {
            resolve(response.data)
          })
        })
      },
      renderResult: (result, props) => `
        <li ${props}>
          <span class="wiki-snippet">
            <img src="http://image.tmdb.org/t/p/original/${result.poster_path}" style="width: 10%;">
          </span>
          <span class="wiki-title">
          ${result.title}
          </span>
        </li>
      `,

      getResultValue: result => result.title,

      onSubmit : result => {
        console.log(result.title)
        fn_selTest(result.title)
      }
    })

  </script>

{% endblock script %}


